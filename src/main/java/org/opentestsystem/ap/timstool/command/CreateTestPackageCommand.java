package org.opentestsystem.ap.timstool.command;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.timstool.ToolProperties;
import org.opentestsystem.ap.timstool.commandline.ToolCommandLine;
import org.opentestsystem.ap.timstool.exception.UsageException;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

import java.nio.file.Path;
import java.nio.file.Paths;

import static org.opentestsystem.ap.timstool.commandline.ToolCommandLineCommands.CMD_CREATE_TEST_PACKAGE;

/**
 * Calls the Test Management Service passing it an Excel spreadsheet.  The response is written to a file.
 */
@Slf4j
@Component
public class CreateTestPackageCommand implements Command {

    private final ToolProperties properties;

    private final RestTemplate restTemplate;

    public CreateTestPackageCommand(ToolProperties properties, RestTemplate restTemplate) {
        this.properties = properties;
        this.restTemplate = restTemplate;
    }

    // ------------------------------------------------------------------------

    @Override
    public void execute(ToolCommandLine commandLine) {
        this.validate(commandLine);
        this.submitRequest(commandLine);
    }

    // ------------------------------------------------------------------------

    private void submitRequest(ToolCommandLine commandLine) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        headers.set("Authorization", "Bearer " + commandLine.getAuthToken());

        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();
        body.add("file", this.getInputFile(commandLine));

        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        ResponseEntity<String> response = this.restTemplate
            .postForEntity(this.properties.getCreateTestManagementEndpoint(), requestEntity, String.class);

        commandLine.printMessage(response.getBody());
    }

    private void validate(ToolCommandLine commandLine) {
        if (!commandLine.hasInputFile()) {
            throw new UsageException(
                "Command " + CMD_CREATE_TEST_PACKAGE + " requires an input file be specified.");
        }
        if (!commandLine.hasOutputFile()) {
            throw new UsageException(
                "Command " + CMD_CREATE_TEST_PACKAGE + " requires an output file be specified.");
        }
        if (!commandLine.hasAuthToken()) {
            throw new UsageException(
                "Command " + CMD_CREATE_TEST_PACKAGE + " requires an authorization token be specified.");
        }
    }

    private Resource getInputFile(ToolCommandLine commandLine) {
        Path inputFile = Paths.get(commandLine.getInputFile());
        return new FileSystemResource(inputFile.toFile());
    }
}

