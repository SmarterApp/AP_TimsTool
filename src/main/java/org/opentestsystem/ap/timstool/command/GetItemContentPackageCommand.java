package org.opentestsystem.ap.timstool.command;

import lombok.extern.slf4j.Slf4j;
import org.opentestsystem.ap.timstool.ToolProperties;
import org.opentestsystem.ap.timstool.commandline.ToolCommandLine;
import org.opentestsystem.ap.timstool.exception.UsageException;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.oauth2.client.OAuth2RestOperations;
import org.springframework.stereotype.Component;
import org.springframework.util.MultiValueMap;

import java.nio.file.Path;

@Slf4j
@Component
public class GetItemContentPackageCommand implements Command {
    private final ToolProperties properties;

    private final OAuth2RestOperations restTemplate;

    private final String commandName;

    public GetItemContentPackageCommand(ToolProperties properties, OAuth2RestOperations restTemplate) {
        this.properties = properties;
        this.restTemplate = restTemplate;
        this.commandName = CommandEnum.GetItemContentCommand.getText();
    }

    // ------------------------------------------------------------------------

    @Override
    public void execute(ToolCommandLine commandLine) {
        this.validate(commandLine);
        commandLine.printMessage("validated..., submitting request to TIMS translation service");
        this.submitRequest(commandLine);
    }

    // ------------------------------------------------------------------------

    private void submitRequest(ToolCommandLine commandLine) {
        HttpHeaders headers = new HttpHeaders();

        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(headers);
        long contentPackageId = commandLine.getContentPackageId();

        ResponseEntity<byte[]> response = this.restTemplate
            .exchange(
                String.format("%s/%s/%s/content", this.properties.getApiGatewayUrl(),
                    this.properties.getTranslationContentPackageEndpoint(), contentPackageId),
                HttpMethod.GET,
                requestEntity,
                byte[].class
            );

        if (response.getStatusCode() == HttpStatus.OK) {
            Path outputFile = commandLine.writeToOutputFile(response.getBody());
            commandLine.printMessage("The results have been written to %s", outputFile.toString());
        } else {
            commandLine
                .printMessage(
                    String.format("Could not fetch item content for content package id %s: \n %s", contentPackageId,
                        response.toString()));
        }
    }

    private void validate(ToolCommandLine commandLine) {
        if (!commandLine.hasOutputFile()) {
            throw new UsageException(String.format("Command %s requires an output file be specified.", commandName));
        }
        if (commandLine.getContentPackageId() == null) {
            throw new UsageException(
                String.format("Command %s requires a content package id be specified.", commandName));
        }
    }
}
